// Teste completo da API Flask - Vers√£o 4.0 (Ampliado com testes abrangentes)
const BASE_URL = "http://localhost:5000/api"

// Configura√ß√£o de cores para output
const colors = {
  reset: "\x1b[0m",
  bright: "\x1b[1m",
  red: "\x1b[31m",
  green: "\x1b[32m",
  yellow: "\x1b[33m",
  blue: "\x1b[34m",
  magenta: "\x1b[35m",
  cyan: "\x1b[36m",
}

// Estado global dos testes
const testState = {
  totalTestes: 0,
  testesPassaram: 0,
  tokens: {},
  usuarios: {},
  debugMode: true,
  // Armazenar IDs de entidades criadas durante os testes para uso posterior
  entidadesCriadas: {
    eventos: [],
    usuarios: [],
    grupos: [],
  },
}

// Fun√ß√£o auxiliar para fazer requisi√ß√µes com debugging melhorado
async function makeRequest(method, url, data = null, token = null, description = "") {
  const options = {
    method: method,
    headers: {
      "Content-Type": "application/json",
    },
  }

  // Adicionar token se fornecido
  if (token) {
    options.headers["Authorization"] = `Bearer ${token}`
    if (testState.debugMode) {
      console.log(`${colors.yellow}üîë Token usado: ${token.substring(0, 20)}...${colors.reset}`)
    }
  }

  // Adicionar dados se fornecido
  if (data) {
    options.body = JSON.stringify(data)
    if (testState.debugMode) {
      console.log(`${colors.blue}üì§ Dados enviados: ${JSON.stringify(data, null, 2)}${colors.reset}`)
    }
  }

  try {
    if (testState.debugMode) {
      console.log(`${colors.cyan}üåê ${method} ${url}${colors.reset}`)
    }

    const response = await fetch(url, options)
    const result = await response.json()

    return {
      status: response.status,
      data: result,
      headers: response.headers,
    }
  } catch (error) {
    console.log(`${colors.red}‚ùå Erro na requisi√ß√£o: ${error.message}${colors.reset}`)
    return {
      status: "ERROR",
      data: { erro: error.message },
      headers: null,
    }
  }
}

// Fun√ß√£o para exibir resultados
function logResult(testName, result, expectedStatus = null) {
  testState.totalTestes++

  const isSuccess = expectedStatus ? result.status === expectedStatus : result.status < 400
  const statusColor = isSuccess ? colors.green : colors.red
  const icon = isSuccess ? "‚úÖ" : "‚ùå"

  if (isSuccess) testState.testesPassaram++

  console.log(`\n${colors.cyan}=== ${testName} ===${colors.reset}`)
  console.log(`${icon} Status: ${statusColor}${result.status}${colors.reset}`)

  // Exibir resposta de forma inteligente
  if (result.data) {
    if (result.data.access_token) {
      console.log(`${colors.yellow}‚úÖ Token recebido: ${result.data.access_token.substring(0, 30)}...${colors.reset}`)
      if (result.data.usuario) {
        console.log(
          `${colors.yellow}üë§ Usu√°rio: ${result.data.usuario.nome} (${result.data.usuario.email})${colors.reset}`,
        )
      }
    } else if (Array.isArray(result.data)) {
      console.log(`${colors.yellow}üìã Array com ${result.data.length} itens${colors.reset}`)
      if (result.data.length > 0) {
        console.log(
          `${colors.yellow}üìÑ Primeiro item: ${JSON.stringify(result.data[0], null, 2).substring(0, 100)}...${colors.reset}`,
        )
      }
    } else {
      const responseStr = JSON.stringify(result.data, null, 2)
      const truncated = responseStr.length > 300 ? responseStr.substring(0, 300) + "..." : responseStr
      console.log(`${colors.yellow}üìÑ Response: ${truncated}${colors.reset}`)
    }
  }

  return isSuccess
}

// Fun√ß√£o para verificar se o servidor est√° rodando
async function verificarServidor() {
  console.log(`${colors.bright}üîç VERIFICANDO SERVIDOR${colors.reset}`)

  try {
    const response = await fetch(BASE_URL.replace("/api", ""))
    if (response.ok) {
      const data = await response.json()
      console.log(`${colors.green}‚úÖ Servidor Flask rodando${colors.reset}`)
      console.log(`${colors.green}‚úÖ Vers√£o: ${data.version || "N/A"}${colors.reset}`)
      console.log(`${colors.green}‚úÖ Database: ${data.database || "N/A"}${colors.reset}`)
      return true
    }
  } catch (error) {
    console.log(`${colors.red}‚ùå Servidor n√£o est√° rodando: ${error.message}${colors.reset}`)
    console.log(`${colors.yellow}üí° Execute: python app.py${colors.reset}`)
    return false
  }
}

// Fun√ß√£o para testar autentica√ß√£o b√°sica
async function testarAutenticacao() {
  console.log(`\n${colors.bright}üîê SE√á√ÉO 1: AUTENTICA√á√ÉO${colors.reset}`)

  // Credenciais de teste baseadas no seed_data
  const credenciais = [
    {
      nome: "RH",
      email: "maria.rh@techsolutions.com",
      senha: "123456",
      tipo: "rh",
    },
    {
      nome: "Gestor",
      email: "joao.gestor@techsolutions.com",
      senha: "123456",
      tipo: "gestor",
    },
    {
      nome: "Usu√°rio Comum",
      email: "ana.dev@techsolutions.com",
      senha: "123456",
      tipo: "comum",
    },
  ]

  // Testar login para cada tipo de usu√°rio
  for (const cred of credenciais) {
    const result = await makeRequest("POST", `${BASE_URL}/auth/login`, {
      email: cred.email,
      senha: cred.senha,
    })

    logResult(`Login ${cred.nome}`, result, 200)

    if (result.status === 200 && result.data.access_token) {
      testState.tokens[cred.tipo] = result.data.access_token
      testState.usuarios[cred.tipo] = result.data.usuario
      console.log(`${colors.green}üîë Token ${cred.tipo} salvo com sucesso${colors.reset}`)
    }
  }

  // Testar login inv√°lido
  const loginInvalido = await makeRequest("POST", `${BASE_URL}/auth/login`, {
    email: "inexistente@test.com",
    senha: "senha_errada",
  })
  logResult("Login Inv√°lido (deve falhar)", loginInvalido, 401)

  // Testar login com senha incorreta
  const loginSenhaIncorreta = await makeRequest("POST", `${BASE_URL}/auth/login`, {
    email: "maria.rh@techsolutions.com",
    senha: "senha_errada",
  })
  logResult("Login com Senha Incorreta (deve falhar)", loginSenhaIncorreta, 401)

  // Testar endpoint /me se temos token
  if (testState.tokens.rh) {
    console.log(`\n${colors.yellow}üß™ Testando endpoint /me com token RH...${colors.reset}`)
    const me = await makeRequest("GET", `${BASE_URL}/auth/me`, null, testState.tokens.rh)
    logResult("Endpoint /me", me, 200)

    // Se falhar, vamos debugar o token
    if (me.status !== 200) {
      console.log(`${colors.red}üîç DEBUG: Token RH pode estar inv√°lido${colors.reset}`)
      console.log(`${colors.red}üîç Token: ${testState.tokens.rh}${colors.reset}`)
    }
  }
}

// Fun√ß√£o para testar endpoints b√°sicos (sem autentica√ß√£o)
async function testarEndpointsPublicos() {
  console.log(`\n${colors.bright}üåç SE√á√ÉO 2: ENDPOINTS P√öBLICOS${colors.reset}`)

  // Testar UFs (pode ser p√∫blico)
  const ufs = await makeRequest("GET", `${BASE_URL}/ufs`)
  logResult("Listar UFs (p√∫blico)", ufs)

  // Testar tipos de aus√™ncia (pode ser p√∫blico)
  const tiposAusencia = await makeRequest("GET", `${BASE_URL}/tipos-ausencia`)
  logResult("Listar Tipos de Aus√™ncia (p√∫blico)", tiposAusencia)

  // Testar turnos (pode ser p√∫blico)
  const turnos = await makeRequest("GET", `${BASE_URL}/turnos`)
  logResult("Listar Turnos (p√∫blico)", turnos)

  // Testar feriados (pode ser p√∫blico)
  const feriados = await makeRequest("GET", `${BASE_URL}/feriados`)
  logResult("Listar Feriados (p√∫blico)", feriados)
}

// Fun√ß√£o para testar endpoints protegidos
async function testarEndpointsProtegidos() {
  console.log(`\n${colors.bright}üîí SE√á√ÉO 3: ENDPOINTS PROTEGIDOS${colors.reset}`)

  // S√≥ continuar se temos pelo menos um token v√°lido
  if (!testState.tokens.rh && !testState.tokens.gestor && !testState.tokens.comum) {
    console.log(`${colors.red}‚ùå Nenhum token v√°lido dispon√≠vel. Pulando testes protegidos.${colors.reset}`)
    return
  }

  // Testar com token RH
  if (testState.tokens.rh) {
    console.log(`\n${colors.cyan}üë©‚Äçüíº Testando com usu√°rio RH${colors.reset}`)

    // Listar usu√°rios
    const usuarios = await makeRequest("GET", `${BASE_URL}/usuarios`, null, testState.tokens.rh)
    logResult("RH - Listar Usu√°rios", usuarios, 200)

    // Listar grupos
    const grupos = await makeRequest("GET", `${BASE_URL}/grupos`, null, testState.tokens.rh)
    logResult("RH - Listar Grupos", grupos, 200)

    // Listar empresas
    const empresas = await makeRequest("GET", `${BASE_URL}/empresas`, null, testState.tokens.rh)
    logResult("RH - Listar Empresas", empresas, 200)

    // Listar calend√°rio
    const calendario = await makeRequest("GET", `${BASE_URL}/calendario`, null, testState.tokens.rh)
    logResult("RH - Listar Calend√°rio", calendario, 200)
  }

  // Testar com token Gestor
  if (testState.tokens.gestor) {
    console.log(`\n${colors.cyan}üë®‚Äçüíº Testando com usu√°rio Gestor${colors.reset}`)

    // Listar usu√°rios do grupo
    const usuariosGrupo = await makeRequest("GET", `${BASE_URL}/usuarios`, null, testState.tokens.gestor)
    logResult("Gestor - Listar Usu√°rios do Grupo", usuariosGrupo, 200)

    // Tentar acessar empresas (deve falhar)
    const empresasGestor = await makeRequest("GET", `${BASE_URL}/empresas`, null, testState.tokens.gestor)
    logResult("Gestor - Tentar Acessar Empresas (deve falhar)", empresasGestor, 403)

    // Listar calend√°rio do grupo
    if (testState.usuarios.gestor && testState.usuarios.gestor.grupo_id) {
      const calendarioGrupo = await makeRequest(
        "GET",
        `${BASE_URL}/calendario/grupo/${testState.usuarios.gestor.grupo_id}`,
        null,
        testState.tokens.gestor,
      )
      logResult("Gestor - Listar Calend√°rio do Grupo", calendarioGrupo, 200)
    }
  }

  // Testar com token Usu√°rio Comum
  if (testState.tokens.comum) {
    console.log(`\n${colors.cyan}üë§ Testando com usu√°rio Comum${colors.reset}`)

    // Listar eventos pr√≥prios
    const eventos = await makeRequest("GET", `${BASE_URL}/eventos`, null, testState.tokens.comum)
    logResult("Usu√°rio - Listar Eventos Pr√≥prios", eventos, 200)

    // Tentar criar usu√°rio (deve falhar)
    const criarUsuario = await makeRequest(
      "POST",
      `${BASE_URL}/usuarios`,
      {
        cpf: "99988877766",
        nome: "Teste Sem Permiss√£o",
        email: "teste@test.com",
        senha: "123456",
      },
      testState.tokens.comum,
    )
    logResult("Usu√°rio - Tentar Criar Usu√°rio (deve falhar)", criarUsuario, 403)

    // Tentar acessar calend√°rio de outro grupo (deve falhar)
    const outroGrupoId = testState.usuarios.comum.grupo_id === 1 ? 2 : 1
    const calendarioOutroGrupo = await makeRequest(
      "GET",
      `${BASE_URL}/calendario/grupo/${outroGrupoId}`,
      null,
      testState.tokens.comum,
    )
    logResult("Usu√°rio - Tentar Acessar Calend√°rio de Outro Grupo (deve falhar)", calendarioOutroGrupo, 403)
  }
}

// Fun√ß√£o para testar opera√ß√µes CRUD b√°sicas
async function testarOperacoesCRUD() {
  console.log(`\n${colors.bright}üìù SE√á√ÉO 4: OPERA√á√ïES CRUD B√ÅSICAS${colors.reset}`)

  if (!testState.tokens.rh) {
    console.log(`${colors.red}‚ùå Token RH necess√°rio para testes CRUD. Pulando.${colors.reset}`)
    return
  }

  // Primeiro, vamos obter informa√ß√µes do usu√°rio RH para usar o CNPJ correto
  let cnpjEmpresaRH = "12345678000190" // CNPJ padr√£o como fallback

  if (testState.usuarios.rh && testState.usuarios.rh.grupo_id) {
    // Tentar obter o CNPJ da empresa do RH
    const grupoRH = await makeRequest(
      "GET",
      `${BASE_URL}/grupos/${testState.usuarios.rh.grupo_id}`,
      null,
      testState.tokens.rh,
    )
    if (grupoRH.status === 200 && grupoRH.data.cnpj_empresa) {
      cnpjEmpresaRH = grupoRH.data.cnpj_empresa
      console.log(`${colors.blue}üè¢ CNPJ da empresa do RH: ${cnpjEmpresaRH}${colors.reset}`)
    }
  }

  // Criar um novo grupo usando o CNPJ correto da empresa do RH
  const novoGrupo = await makeRequest(
    "POST",
    `${BASE_URL}/grupos`,
    {
      nome: `Grupo Teste ${Date.now()}`,
      cnpj_empresa: cnpjEmpresaRH, // Usar o CNPJ da empresa do RH
      telefone: "(11) 1234-5678",
      descricao: "Grupo criado durante teste automatizado",
    },
    testState.tokens.rh,
  )
  const sucessoGrupo = logResult("Criar Novo Grupo", novoGrupo, 201)

  // Se grupo foi criado, tentar atualiz√°-lo
  if (sucessoGrupo && novoGrupo.data.id) {
    // Salvar ID do grupo para uso posterior
    testState.entidadesCriadas.grupos.push(novoGrupo.data.id)

    const atualizarGrupo = await makeRequest(
      "PUT",
      `${BASE_URL}/grupos/${novoGrupo.data.id}`,
      {
        descricao: "Grupo atualizado durante teste",
      },
      testState.tokens.rh,
    )
    logResult("Atualizar Grupo Criado", atualizarGrupo, 200)
  }

  // Criar um novo evento
  if (testState.tokens.comum) {
    const novoEvento = await makeRequest(
      "POST",
      `${BASE_URL}/eventos`,
      {
        cpf_usuario: testState.usuarios.comum?.cpf || "34567890123",
        data_inicio: "2025-06-15",
        data_fim: "2025-06-19",
        id_tipo_ausencia: 1,
        uf: "SP",
      },
      testState.tokens.comum,
    )
    const sucessoEvento = logResult("Usu√°rio - Criar Novo Evento", novoEvento, 201)

    // Salvar ID do evento para uso posterior
    if (sucessoEvento && novoEvento.data.id) {
      testState.entidadesCriadas.eventos.push(novoEvento.data.id)
    }
  }
}

// Fun√ß√£o para testar valida√ß√µes de seguran√ßa
async function testarSeguranca() {
  console.log(`\n${colors.bright}üõ°Ô∏è SE√á√ÉO 5: VALIDA√á√ïES DE SEGURAN√áA${colors.reset}`)

  // Acesso sem token
  const semToken = await makeRequest("GET", `${BASE_URL}/usuarios`)
  logResult("Acesso sem token (deve falhar)", semToken, 401)

  // Token inv√°lido
  const tokenInvalido = await makeRequest("GET", `${BASE_URL}/usuarios`, null, "token-completamente-invalido")
  logResult("Token inv√°lido (deve falhar)", tokenInvalido, 401)

  // Token malformado
  const tokenMalformado = await makeRequest("GET", `${BASE_URL}/usuarios`, null, "Bearer token-malformado")
  logResult("Token malformado (deve falhar)", tokenMalformado, 401)

  // Tentar acessar recurso de outro usu√°rio
  if (testState.tokens.comum && testState.usuarios.gestor) {
    const acessoNaoAutorizado = await makeRequest(
      "GET",
      `${BASE_URL}/usuarios/${testState.usuarios.gestor.cpf}`,
      null,
      testState.tokens.comum,
    )
    logResult("Acessar Recurso de Outro Usu√°rio (deve falhar)", acessoNaoAutorizado, 403)
  }

  // Tentar criar grupo com CNPJ inv√°lido
  if (testState.tokens.rh) {
    const grupoInvalido = await makeRequest(
      "POST",
      `${BASE_URL}/grupos`,
      {
        nome: "Grupo Teste Inv√°lido",
        cnpj_empresa: "99999999999999", // CNPJ inv√°lido
        telefone: "(11) 1234-5678",
      },
      testState.tokens.rh,
    )
    logResult("Criar Grupo com CNPJ Inv√°lido (deve falhar)", grupoInvalido, 400)
  }
}

// Fun√ß√£o para testar logout
async function testarLogout() {
  console.log(`\n${colors.bright}üö™ SE√á√ÉO 6: LOGOUT${colors.reset}`)

  if (testState.tokens.rh) {
    const logout = await makeRequest("POST", `${BASE_URL}/auth/logout`, null, testState.tokens.rh)
    logResult("Logout RH", logout, 200)

    // Tentar usar token ap√≥s logout
    const aposLogout = await makeRequest("GET", `${BASE_URL}/auth/me`, null, testState.tokens.rh)
    logResult("Usar token ap√≥s logout (deve falhar)", aposLogout, 401)
  }
}

// NOVA FUN√á√ÉO: Testar fluxo de aprova√ß√£o de eventos
async function testarAprovacaoEventos() {
  console.log(`\n${colors.bright}üóìÔ∏è SE√á√ÉO 7: FLUXO DE APROVA√á√ÉO DE EVENTOS${colors.reset}`)

  // Verificar se temos tokens necess√°rios
  if (!testState.tokens.comum || !testState.tokens.gestor) {
    console.log(`${colors.red}‚ùå Tokens de usu√°rio comum e gestor necess√°rios. Pulando.${colors.reset}`)
    return
  }

  // 1. Criar evento como usu√°rio comum
  const novoEvento = await makeRequest(
    "POST",
    `${BASE_URL}/eventos`,
    {
      cpf_usuario: testState.usuarios.comum?.cpf,
      data_inicio: "2025-07-10",
      data_fim: "2025-07-15",
      id_tipo_ausencia: 1,
      uf: "SP",
    },
    testState.tokens.comum,
  )
  const sucessoEvento = logResult("Criar Evento para Aprova√ß√£o", novoEvento, 201)

  if (sucessoEvento && novoEvento.data.id) {
    const eventoId = novoEvento.data.id
    testState.entidadesCriadas.eventos.push(eventoId)

    // 2. Tentar aprovar como usu√°rio comum (deve falhar)
    const aprovarComum = await makeRequest(
      "POST",
      `${BASE_URL}/eventos/${eventoId}/aprovar`,
      { aprovador_cpf: testState.usuarios.comum?.cpf },
      testState.tokens.comum,
    )
    logResult("Aprovar Evento como Usu√°rio Comum (deve falhar)", aprovarComum, 403)

    // 3. Aprovar como gestor
    const aprovarGestor = await makeRequest(
      "POST",
      `${BASE_URL}/eventos/${eventoId}/aprovar`,
      { aprovador_cpf: testState.usuarios.gestor?.cpf },
      testState.tokens.gestor,
    )
    logResult("Aprovar Evento como Gestor", aprovarGestor, 200)

    // 4. Verificar status do evento
    const verificarEvento = await makeRequest("GET", `${BASE_URL}/eventos/${eventoId}`, null, testState.tokens.gestor)
    logResult("Verificar Status do Evento Aprovado", verificarEvento, 200)

    // 5. Criar outro evento para rejei√ß√£o
    const eventoParaRejeitar = await makeRequest(
      "POST",
      `${BASE_URL}/eventos`,
      {
        cpf_usuario: testState.usuarios.comum?.cpf,
        data_inicio: "2025-08-10",
        data_fim: "2025-08-15",
        id_tipo_ausencia: 1,
        uf: "SP",
      },
      testState.tokens.comum,
    )

    if (eventoParaRejeitar.status === 201 && eventoParaRejeitar.data.id) {
      const eventoRejeitadoId = eventoParaRejeitar.data.id
      testState.entidadesCriadas.eventos.push(eventoRejeitadoId)

      // 6. Rejeitar como gestor
      const rejeitarGestor = await makeRequest(
        "POST",
        `${BASE_URL}/eventos/${eventoRejeitadoId}/rejeitar`,
        { aprovador_cpf: testState.usuarios.gestor?.cpf },
        testState.tokens.gestor,
      )
      logResult("Rejeitar Evento como Gestor", rejeitarGestor, 200)

      // 7. Verificar status do evento rejeitado
      const verificarRejeitado = await makeRequest(
        "GET",
        `${BASE_URL}/eventos/${eventoRejeitadoId}`,
        null,
        testState.tokens.gestor,
      )
      logResult("Verificar Status do Evento Rejeitado", verificarRejeitado, 200)
    }
  }
}

// NOVA FUN√á√ÉO: Testar cria√ß√£o de usu√°rios com diferentes pap√©is
async function testarCriacaoUsuarios() {
  console.log(`\n${colors.bright}üë• SE√á√ÉO 8: CRIA√á√ÉO DE USU√ÅRIOS${colors.reset}`)

  if (!testState.tokens.rh || !testState.tokens.gestor) {
    console.log(`${colors.red}‚ùå Tokens de RH e gestor necess√°rios. Pulando.${colors.reset}`)
    return
  }

  // 1. Criar usu√°rio comum como RH
  const cpfUsuarioComum = Math.floor(10000000000 + Math.random() * 90000000000)
  const novoUsuarioComum = await makeRequest(
    "POST",
    `${BASE_URL}/usuarios`,
    {
      cpf: cpfUsuarioComum,
      nome: "Novo Usu√°rio Comum",
      email: `novo.comum.${Date.now()}@techsolutions.com`,
      senha: "123456",
      grupo_id: testState.usuarios.comum?.grupo_id,
      inicio_na_empresa: "2025-01-01",
      uf: "SP",
      tipo_usuario: "comum",
      flag_gestor: "N",
    },
    testState.tokens.rh,
  )
  const sucessoUsuarioComum = logResult("Criar Usu√°rio Comum como RH", novoUsuarioComum, 201)

  if (sucessoUsuarioComum) {
    testState.entidadesCriadas.usuarios.push(cpfUsuarioComum)
  }

  // 2. Criar usu√°rio gestor como RH
  const cpfUsuarioGestor = Math.floor(10000000000 + Math.random() * 90000000000)
  const novoUsuarioGestor = await makeRequest(
    "POST",
    `${BASE_URL}/usuarios`,
    {
      cpf: cpfUsuarioGestor,
      nome: "Novo Usu√°rio Gestor",
      email: `novo.gestor.${Date.now()}@techsolutions.com`,
      senha: "123456",
      grupo_id: testState.usuarios.gestor?.grupo_id,
      inicio_na_empresa: "2025-01-01",
      uf: "SP",
      tipo_usuario: "comum",
      flag_gestor: "S",
    },
    testState.tokens.rh,
  )
  const sucessoUsuarioGestor = logResult("Criar Usu√°rio Gestor como RH", novoUsuarioGestor, 201)

  if (sucessoUsuarioGestor) {
    testState.entidadesCriadas.usuarios.push(cpfUsuarioGestor)
  }

  // 3. Tentar criar usu√°rio em grupo n√£o autorizado
  const grupoNaoAutorizado = testState.usuarios.gestor?.grupo_id === 1 ? 2 : 1
  const cpfUsuarioInvalido = Math.floor(10000000000 + Math.random() * 90000000000)
  const usuarioGrupoInvalido = await makeRequest(
    "POST",
    `${BASE_URL}/usuarios`,
    {
      cpf: cpfUsuarioInvalido,
      nome: "Usu√°rio Grupo Inv√°lido",
      email: `grupo.invalido.${Date.now()}@techsolutions.com`,
      senha: "123456",
      grupo_id: grupoNaoAutorizado,
      inicio_na_empresa: "2025-01-01",
      uf: "SP",
    },
    testState.tokens.gestor,
  )
  logResult("Criar Usu√°rio em Grupo N√£o Autorizado (deve falhar)", usuarioGrupoInvalido, 403)

  // 4. Tentar criar usu√°rio com CPF inv√°lido
  const usuarioCpfInvalido = await makeRequest(
    "POST",
    `${BASE_URL}/usuarios`,
    {
      cpf: "123", // CPF inv√°lido
      nome: "Usu√°rio CPF Inv√°lido",
      email: `cpf.invalido.${Date.now()}@techsolutions.com`,
      senha: "123456",
      grupo_id: testState.usuarios.rh?.grupo_id,
      inicio_na_empresa: "2025-01-01",
      uf: "SP",
    },
    testState.tokens.rh,
  )
  logResult("Criar Usu√°rio com CPF Inv√°lido (deve falhar)", usuarioCpfInvalido, 400)

  // 5. Tentar criar usu√°rio com email duplicado
  if (sucessoUsuarioComum) {
    const usuarioEmailDuplicado = await makeRequest(
      "POST",
      `${BASE_URL}/usuarios`,
      {
        cpf: Math.floor(10000000000 + Math.random() * 90000000000),
        nome: "Usu√°rio Email Duplicado",
        email: novoUsuarioComum.data.email, // Email j√° usado
        senha: "123456",
        grupo_id: testState.usuarios.rh?.grupo_id,
        inicio_na_empresa: "2025-01-01",
        uf: "SP",
      },
      testState.tokens.rh,
    )
    logResult("Criar Usu√°rio com Email Duplicado (deve falhar)", usuarioEmailDuplicado, 409)
  }
}

// NOVA FUN√á√ÉO: Testar gerenciamento completo de grupos
async function testarGerenciamentoGrupos() {
  console.log(`\n${colors.bright}üè¢ SE√á√ÉO 9: GERENCIAMENTO DE GRUPOS${colors.reset}`)

  if (!testState.tokens.rh) {
    console.log(`${colors.red}‚ùå Token RH necess√°rio. Pulando.${colors.reset}`)
    return
  }

  // 1. Obter CNPJ da empresa do RH
  let cnpjEmpresaRH = "12345678000190"
  if (testState.usuarios.rh && testState.usuarios.rh.grupo_id) {
    const grupoRH = await makeRequest(
      "GET",
      `${BASE_URL}/grupos/${testState.usuarios.rh.grupo_id}`,
      null,
      testState.tokens.rh,
    )
    if (grupoRH.status === 200 && grupoRH.data.cnpj_empresa) {
      cnpjEmpresaRH = grupoRH.data.cnpj_empresa
    }
  }

  // 2. Criar grupo com dados inv√°lidos
  const grupoInvalido = await makeRequest(
    "POST",
    `${BASE_URL}/grupos`,
    {
      nome: "", // Nome vazio
      cnpj_empresa: cnpjEmpresaRH,
      telefone: "(11) 1234-5678",
    },
    testState.tokens.rh,
  )
  logResult("Criar Grupo com Dados Inv√°lidos (deve falhar)", grupoInvalido, 400)

  // 3. Criar grupo v√°lido
  const novoGrupo = await makeRequest(
    "POST",
    `${BASE_URL}/grupos`,
    {
      nome: `Grupo Teste Completo ${Date.now()}`,
      cnpj_empresa: cnpjEmpresaRH,
      telefone: "(11) 1234-5678",
      descricao: "Grupo para teste completo",
    },
    testState.tokens.rh,
  )
  const sucessoGrupo = logResult("Criar Novo Grupo V√°lido", novoGrupo, 201)

  if (sucessoGrupo && novoGrupo.data.id) {
    const grupoId = novoGrupo.data.id
    testState.entidadesCriadas.grupos.push(grupoId)

    // 4. Atualizar grupo
    const atualizarGrupo = await makeRequest(
      "PUT",
      `${BASE_URL}/grupos/${grupoId}`,
      {
        nome: "Grupo Atualizado",
        descricao: "Descri√ß√£o atualizada durante teste",
      },
      testState.tokens.rh,
    )
    logResult("Atualizar Grupo", atualizarGrupo, 200)

    // 5. Tentar atualizar como gestor (deve falhar)
    if (testState.tokens.gestor) {
      const atualizarGestor = await makeRequest(
        "PUT",
        `${BASE_URL}/grupos/${grupoId}`,
        {
          descricao: "Tentativa de atualiza√ß√£o por gestor",
        },
        testState.tokens.gestor,
      )
      logResult("Atualizar Grupo como Gestor (deve falhar)", atualizarGestor, 403)
    }

    // 6. Desativar grupo
    const desativarGrupo = await makeRequest("DELETE", `${BASE_URL}/grupos/${grupoId}`, null, testState.tokens.rh)
    logResult("Desativar Grupo", desativarGrupo, 200)

    // 7. Verificar se grupo est√° desativado
    const verificarGrupo = await makeRequest("GET", `${BASE_URL}/grupos/${grupoId}`, null, testState.tokens.rh)
    logResult("Verificar Grupo Desativado", verificarGrupo, 200)
  }
}

// NOVA FUN√á√ÉO: Testar valida√ß√£o de dados e casos de borda
async function testarValidacaoDados() {
  console.log(`\n${colors.bright}üîç SE√á√ÉO 10: VALIDA√á√ÉO DE DADOS${colors.reset}`)

  if (!testState.tokens.comum || !testState.tokens.rh) {
    console.log(`${colors.red}‚ùå Tokens necess√°rios. Pulando.${colors.reset}`)
    return
  }

  // 1. Evento com data final anterior √† data inicial
  const eventoDataInvalida = await makeRequest(
    "POST",
    `${BASE_URL}/eventos`,
    {
      cpf_usuario: testState.usuarios.comum?.cpf,
      data_inicio: "2025-07-15", // Data posterior √† final
      data_fim: "2025-07-10",
      id_tipo_ausencia: 1,
      uf: "SP",
    },
    testState.tokens.comum,
  )
  logResult("Criar Evento com Data Inv√°lida (deve falhar)", eventoDataInvalida, 400)

  // 2. Evento com tipo de aus√™ncia inexistente
  const eventoTipoInexistente = await makeRequest(
    "POST",
    `${BASE_URL}/eventos`,
    {
      cpf_usuario: testState.usuarios.comum?.cpf,
      data_inicio: "2025-07-10",
      data_fim: "2025-07-15",
      id_tipo_ausencia: 9999, // Tipo inexistente
      uf: "SP",
    },
    testState.tokens.comum,
  )
  logResult("Criar Evento com Tipo Inexistente (deve falhar)", eventoTipoInexistente, 400)

  // 3. Usu√°rio com UF inv√°lida
  const cpfUsuarioUfInvalida = Math.floor(10000000000 + Math.random() * 90000000000)
  const usuarioUfInvalida = await makeRequest(
    "POST",
    `${BASE_URL}/usuarios`,
    {
      cpf: cpfUsuarioUfInvalida,
      nome: "Usu√°rio UF Inv√°lida",
      email: `uf.invalida.${Date.now()}@techsolutions.com`,
      senha: "123456",
      grupo_id: testState.usuarios.rh?.grupo_id,
      inicio_na_empresa: "2025-01-01",
      uf: "XX", // UF inv√°lida
    },
    testState.tokens.rh,
  )
  logResult("Criar Usu√°rio com UF Inv√°lida (deve falhar)", usuarioUfInvalida, 400)

  // 4. Grupo sem telefone (campo obrigat√≥rio)
  let cnpjEmpresaRH = "12345678000190"
  if (testState.usuarios.rh && testState.usuarios.rh.grupo_id) {
    const grupoRH = await makeRequest(
      "GET",
      `${BASE_URL}/grupos/${testState.usuarios.rh.grupo_id}`,
      null,
      testState.tokens.rh,
    )
    if (grupoRH.status === 200 && grupoRH.data.cnpj_empresa) {
      cnpjEmpresaRH = grupoRH.data.cnpj_empresa
    }
  }

  const grupoSemTelefone = await makeRequest(
    "POST",
    `${BASE_URL}/grupos`,
    {
      nome: `Grupo Sem Telefone ${Date.now()}`,
      cnpj_empresa: cnpjEmpresaRH,
      // Telefone omitido
    },
    testState.tokens.rh,
  )
  logResult("Criar Grupo Sem Telefone (deve falhar)", grupoSemTelefone, 400)
}

// NOVA FUN√á√ÉO: Testar calend√°rio e visualiza√ß√µes
async function testarCalendario() {
  console.log(`\n${colors.bright}üìÖ SE√á√ÉO 11: CALEND√ÅRIO E VISUALIZA√á√ïES${colors.reset}`)

  if (!testState.tokens.rh || !testState.tokens.gestor || !testState.tokens.comum) {
    console.log(`${colors.red}‚ùå Tokens necess√°rios. Pulando.${colors.reset}`)
    return
  }

  // 1. Calend√°rio geral (RH)
  const calendarioRH = await makeRequest("GET", `${BASE_URL}/calendario`, null, testState.tokens.rh)
  logResult("Calend√°rio Geral (RH)", calendarioRH, 200)

  // 2. Calend√°rio com filtro de data
  const dataInicio = new Date()
  const dataFim = new Date()
  dataFim.setMonth(dataFim.getMonth() + 3) // 3 meses √† frente

  const calendarioFiltrado = await makeRequest(
    "GET",
    `${BASE_URL}/calendario?inicio=${dataInicio.toISOString().split("T")[0]}&fim=${dataFim.toISOString().split("T")[0]}`,
    null,
    testState.tokens.rh,
  )
  logResult("Calend√°rio com Filtro de Data", calendarioFiltrado, 200)

  // 3. Calend√°rio de grupo espec√≠fico
  if (testState.usuarios.gestor && testState.usuarios.gestor.grupo_id) {
    const calendarioGrupo = await makeRequest(
      "GET",
      `${BASE_URL}/calendario/grupo/${testState.usuarios.gestor.grupo_id}`,
      null,
      testState.tokens.gestor,
    )
    logResult("Calend√°rio de Grupo Espec√≠fico", calendarioGrupo, 200)
  }

  // 4. Calend√°rio com filtro de tipo de aus√™ncia
  const calendarioTipoAusencia = await makeRequest(
    "GET",
    `${BASE_URL}/calendario?tipo_ausencia=1`,
    null,
    testState.tokens.rh,
  )
  logResult("Calend√°rio com Filtro de Tipo de Aus√™ncia", calendarioTipoAusencia, 200)

  // 5. Usu√°rio comum s√≥ deve ver eventos do seu grupo
  const calendarioUsuarioComum = await makeRequest("GET", `${BASE_URL}/calendario`, null, testState.tokens.comum)
  logResult("Calend√°rio para Usu√°rio Comum", calendarioUsuarioComum, 200)
}

// Fun√ß√£o para limpar dados de teste
async function limparDadosTeste() {
  console.log(`\n${colors.bright}üßπ LIMPEZA DE DADOS DE TESTE${colors.reset}`)

  if (!testState.tokens.rh) {
    console.log(`${colors.red}‚ùå Token RH necess√°rio para limpeza. Pulando.${colors.reset}`)
    return
  }

  // Limpar eventos criados
  for (const eventoId of testState.entidadesCriadas.eventos) {
    const deletarEvento = await makeRequest("DELETE", `${BASE_URL}/eventos/${eventoId}`, null, testState.tokens.rh)
    logResult(`Deletar Evento ID ${eventoId}`, deletarEvento, 200)
  }

  // Limpar usu√°rios criados
  for (const cpfUsuario of testState.entidadesCriadas.usuarios) {
    const deletarUsuario = await makeRequest("DELETE", `${BASE_URL}/usuarios/${cpfUsuario}`, null, testState.tokens.rh)
    logResult(`Deletar Usu√°rio CPF ${cpfUsuario}`, deletarUsuario, 200)
  }

  // Limpar grupos criados (j√° foram desativados nos testes)
  console.log(
    `${colors.green}‚úÖ ${testState.entidadesCriadas.grupos.length} grupos foram desativados durante os testes${colors.reset}`,
  )
}

// Fun√ß√£o para gerar relat√≥rio final
function gerarRelatorio() {
  console.log(`\n${colors.bright}üìä RELAT√ìRIO FINAL${colors.reset}`)
  console.log("=".repeat(60))

  const porcentagemSucesso = ((testState.testesPassaram / testState.totalTestes) * 100).toFixed(1)
  const statusColor = porcentagemSucesso >= 90 ? colors.green : porcentagemSucesso >= 70 ? colors.yellow : colors.red

  console.log(`${colors.bright}Total de Testes:${colors.reset} ${testState.totalTestes}`)
  console.log(`${colors.green}Testes Passaram:${colors.reset} ${testState.testesPassaram}`)
  console.log(`${colors.red}Testes Falharam:${colors.reset} ${testState.totalTestes - testState.testesPassaram}`)
  console.log(`${colors.bright}Taxa de Sucesso:${colors.reset} ${statusColor}${porcentagemSucesso}%${colors.reset}`)

  console.log(`\n${colors.bright}üîë TOKENS OBTIDOS:${colors.reset}`)
  Object.keys(testState.tokens).forEach((tipo) => {
    console.log(`${colors.green}‚úÖ ${tipo.toUpperCase()}: ${testState.tokens[tipo] ? "OK" : "FALHOU"}${colors.reset}`)
  })

  console.log(`\n${colors.bright}üìà ESTAT√çSTICAS DE ENTIDADES:${colors.reset}`)
  console.log(`${colors.blue}üóìÔ∏è Eventos testados: ${testState.entidadesCriadas.eventos.length}${colors.reset}`)
  console.log(`${colors.blue}üë§ Usu√°rios testados: ${testState.entidadesCriadas.usuarios.length}${colors.reset}`)
  console.log(`${colors.blue}üè¢ Grupos testados: ${testState.entidadesCriadas.grupos.length}${colors.reset}`)

  console.log(`\n${colors.bright}üí° DIAGN√ìSTICO:${colors.reset}`)
  if (porcentagemSucesso >= 90) {
    console.log(`${colors.green}üéâ API funcionando perfeitamente!${colors.reset}`)
  } else if (porcentagemSucesso >= 70) {
    console.log(`${colors.yellow}‚ö†Ô∏è API funcionando com alguns problemas${colors.reset}`)
  } else if (Object.keys(testState.tokens).length === 0) {
    console.log(`${colors.red}üö® PROBLEMA CR√çTICO: Nenhum login funcionou${colors.reset}`)
    console.log(`${colors.yellow}üîß Verifique as credenciais no banco de dados${colors.reset}`)
    console.log(`${colors.yellow}üîß Execute: python scripts/seed_data_complete.py${colors.reset}`)
  } else if (testState.testesPassaram < 5) {
    console.log(`${colors.red}üö® PROBLEMA CR√çTICO: Tokens n√£o est√£o funcionando${colors.reset}`)
    console.log(`${colors.yellow}üîß Verifique a configura√ß√£o JWT no Flask${colors.reset}`)
    console.log(`${colors.yellow}üîß Verifique a vari√°vel JWT_SECRET_KEY${colors.reset}`)
  } else {
    console.log(`${colors.yellow}‚ö†Ô∏è Alguns endpoints podem estar com problemas${colors.reset}`)
  }

  console.log(`\n${colors.bright}üîß COMANDOS √öTEIS:${colors.reset}`)
  console.log(`${colors.cyan}- Recriar dados: python scripts/seed_data_complete.py${colors.reset}`)
  console.log(`${colors.cyan}- Verificar integridade: python scripts/validate_integrity.py${colors.reset}`)
  console.log(`${colors.cyan}- Verificar ambiente: python scripts/check_environment.py${colors.reset}`)
}

// Fun√ß√£o principal
async function executarTestes() {
  console.log(`${colors.bright}üöÄ TESTE COMPLETO DA API - VERS√ÉO 4.0${colors.reset}`)
  console.log(`${colors.blue}üìÖ ${new Date().toLocaleString("pt-BR")}${colors.reset}`)
  console.log(`${colors.blue}üîó Base URL: ${BASE_URL}${colors.reset}\n`)

  // Verificar se servidor est√° rodando
  const servidorOk = await verificarServidor()
  if (!servidorOk) {
    console.log(`${colors.red}‚ùå N√£o √© poss√≠vel continuar sem o servidor${colors.reset}`)
    return
  }

  try {
    // Executar todas as se√ß√µes de teste
    await testarAutenticacao()
    await testarEndpointsPublicos()
    await testarEndpointsProtegidos()
    await testarOperacoesCRUD()
    await testarSeguranca()

    // Novas se√ß√µes de teste
    await testarAprovacaoEventos()
    await testarCriacaoUsuarios()
    await testarGerenciamentoGrupos()
    await testarValidacaoDados()
    await testarCalendario()

    // Limpar dados de teste
    await limparDadosTeste()

    // Testar logout por √∫ltimo
    await testarLogout()

    // Gerar relat√≥rio final
    gerarRelatorio()
  } catch (error) {
    console.log(`${colors.red}‚ùå Erro durante execu√ß√£o dos testes: ${error.message}${colors.reset}`)
    console.log(`${colors.red}Stack: ${error.stack}${colors.reset}`)
  }
}

// Executar testes
console.log(`${colors.bright}üéØ Iniciando testes da API Flask...${colors.reset}`)
console.log(`${colors.yellow}‚öôÔ∏è Modo debug: ${testState.debugMode ? "ATIVADO" : "DESATIVADO"}${colors.reset}`)
console.log(`${colors.yellow}üîß Para desativar debug, mude debugMode para false${colors.reset}\n`)

executarTestes().catch((error) => {
  console.error(`${colors.red}üí• Erro fatal: ${error.message}${colors.reset}`)
})
